<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Growth Simulator â€” V5.2 System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0f;
    --bg-card: #111118;
    --bg-card-hover: #16161f;
    --border: #1e1e2e;
    --green: #00ff88;
    --green-dim: rgba(0, 255, 136, 0.12);
    --red: #ff4444;
    --red-dim: rgba(255, 68, 68, 0.12);
    --text: #e4e4e7;
    --text-dim: #71717a;
    --text-muted: #a1a1aa;
    --gold: #fbbf24;
    --blue: #3b82f6;
    --purple: #a855f7;
    --cyan: #06b6d4;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, sans-serif;
    line-height: 1.6;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.015) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.015) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px 16px 60px;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header {
    text-align: center;
    padding: 28px 20px 20px;
    margin-bottom: 28px;
    position: relative;
  }

  .header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green), transparent);
  }

  .header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 6px;
  }

  .header h1 .accent {
    background: linear-gradient(135deg, var(--green), #00cc6a);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .header-sub {
    font-size: 0.8rem;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .header-sub .tag {
    background: var(--green-dim);
    color: var(--green);
    padding: 2px 10px;
    border-radius: 100px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  /* â”€â”€â”€ SECTION TITLES â”€â”€â”€ */
  .section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* â”€â”€â”€ CONTROLS â”€â”€â”€ */
  .controls {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 28px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    position: relative;
    overflow: hidden;
  }

  .controls::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green), transparent);
    opacity: 0.4;
  }

  .control-group label {
    display: block;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .control-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .control-row input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    outline: none;
  }

  .control-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--green);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,255,136,0.3);
  }

  .control-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--green);
    min-width: 70px;
    text-align: right;
  }

  .preset-btns {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  .preset-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'JetBrains Mono', monospace;
  }

  .preset-btn:hover { border-color: var(--green); color: var(--green); }
  .preset-btn.active { border-color: var(--green); color: var(--green); background: var(--green-dim); }

  .run-btn-wrap {
    display: flex;
    align-items: flex-end;
  }

  .run-btn {
    width: 100%;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--green), #00cc6a);
    color: #0a0a0f;
    border: none;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }

  .run-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,255,136,0.2); }
  .run-btn:active { transform: translateY(0); }
  .run-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* â”€â”€â”€ CHART â”€â”€â”€ */
  .chart-section {
    margin-bottom: 28px;
  }

  .chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .chart-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green), transparent);
    opacity: 0.3;
  }

  .chart-container {
    position: relative;
    height: 380px;
    width: 100%;
  }

  .chart-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 12px;
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .chart-legend span {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-dot {
    width: 10px;
    height: 3px;
    border-radius: 2px;
  }

  /* â”€â”€â”€ SCENARIO CARDS â”€â”€â”€ */
  .scenarios {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 28px;
  }

  .scenario-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px 16px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .scenario-card:hover {
    border-color: rgba(255,255,255,0.08);
    transform: translateY(-2px);
  }

  .scenario-card.active {
    border-color: var(--green);
    background: rgba(0,255,136,0.03);
  }

  .scenario-card.active::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--green);
  }

  .scenario-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .scenario-risk {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 10px;
  }

  .scenario-metric {
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-bottom: 3px;
  }

  .scenario-metric .val {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    color: var(--text-muted);
  }

  .scenario-metric .val.green { color: var(--green); }
  .scenario-metric .val.red { color: var(--red); }
  .scenario-metric .val.gold { color: var(--gold); }

  /* â”€â”€â”€ MILESTONES â”€â”€â”€ */
  .milestones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 14px;
    margin-bottom: 28px;
  }

  .milestone-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    position: relative;
    overflow: hidden;
  }

  .milestone-target {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2px;
  }

  .milestone-mult {
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  .milestone-bar-wrap {
    height: 4px;
    background: rgba(255,255,255,0.05);
    border-radius: 4px;
    margin-bottom: 10px;
    overflow: hidden;
  }

  .milestone-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
  }

  .milestone-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.72rem;
  }

  .milestone-stats .label { color: var(--text-dim); }
  .milestone-stats .val {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
  }

  /* â”€â”€â”€ DISTRIBUTION â”€â”€â”€ */
  .dist-section {
    margin-bottom: 28px;
  }

  .dist-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
  }

  .dist-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .dist-chart-wrap {
    height: 200px;
    position: relative;
  }

  .stat-block {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
    font-size: 0.82rem;
  }

  .stat-row .label { color: var(--text-dim); }
  .stat-row .val {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
  }

  /* â”€â”€â”€ BACKTEST SOURCE â”€â”€â”€ */
  .source-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    margin-bottom: 28px;
    font-size: 0.82rem;
    color: var(--text-dim);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 8px 20px;
  }

  .source-item {
    display: flex;
    justify-content: space-between;
  }

  .source-item .val {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    color: var(--text-muted);
  }

  /* â”€â”€â”€ FOOTER â”€â”€â”€ */
  .footer {
    text-align: center;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    margin-top: 32px;
  }

  .footer a {
    color: var(--text-dim);
    text-decoration: none;
    font-size: 0.85rem;
    transition: color 0.2s;
  }

  .footer a:hover { color: var(--green); }

  .footer-info {
    font-size: 0.72rem;
    color: var(--text-dim);
    margin-top: 6px;
  }

  /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
  @media (max-width: 768px) {
    .scenarios { grid-template-columns: repeat(2, 1fr); }
    .chart-container { height: 280px; }
    .dist-grid { grid-template-columns: 1fr; }
    .milestones-grid { grid-template-columns: 1fr 1fr; }
  }

  @media (max-width: 480px) {
    .scenarios { grid-template-columns: 1fr 1fr; }
    .milestones-grid { grid-template-columns: 1fr; }
    .container { padding: 12px 10px 40px; }
    .controls { grid-template-columns: 1fr; }
  }

  /* â”€â”€â”€ ANIMATION â”€â”€â”€ */
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .animate-in { animation: slideIn 0.4s ease forwards; }
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <h1>ğŸ“ˆ <span class="accent">Compound Growth</span> Simulator</h1>
    <div class="header-sub">
      <span class="tag">V5.2 SYSTEM</span>
      <span>87 trades Â· 63% WR Â· +115.88R Â· 3 pairs Ã— 3 TFs</span>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="section-title">âš™ï¸ Parameters</div>
  <div class="controls">
    <div class="control-group">
      <label>Starting Balance</label>
      <div class="control-row">
        <input type="range" id="balSlider" min="50" max="10000" step="10" value="79">
        <span class="control-value" id="balValue">$79</span>
      </div>
      <div class="preset-btns" id="balPresets">
        <button class="preset-btn active" data-val="79">$79</button>
        <button class="preset-btn" data-val="500">$500</button>
        <button class="preset-btn" data-val="1000">$1K</button>
        <button class="preset-btn" data-val="5000">$5K</button>
        <button class="preset-btn" data-val="10000">$10K</button>
      </div>
    </div>

    <div class="control-group">
      <label>Risk Per Trade</label>
      <div class="control-row">
        <input type="range" id="riskSlider" min="0.5" max="10" step="0.5" value="2">
        <span class="control-value" id="riskValue">2.0%</span>
      </div>
      <div class="preset-btns" id="riskPresets">
        <button class="preset-btn" data-val="1">1%</button>
        <button class="preset-btn active" data-val="2">2%</button>
        <button class="preset-btn" data-val="3">3%</button>
        <button class="preset-btn" data-val="5">5%</button>
      </div>
    </div>

    <div class="control-group">
      <label>Trades to Simulate</label>
      <div class="control-row">
        <input type="range" id="tradesSlider" min="50" max="1000" step="10" value="300">
        <span class="control-value" id="tradesValue">300</span>
      </div>
      <div class="preset-btns" id="tradePresets">
        <button class="preset-btn" data-val="100">100</button>
        <button class="preset-btn active" data-val="300">300</button>
        <button class="preset-btn" data-val="500">500</button>
        <button class="preset-btn" data-val="1000">1000</button>
      </div>
    </div>

    <div class="run-btn-wrap">
      <button class="run-btn" id="runBtn" onclick="runSimulation()">
        ğŸš€ Run Simulation (500 paths)
      </button>
    </div>
  </div>

  <!-- MONTE CARLO CHART -->
  <div class="chart-section">
    <div class="section-title">ğŸ“Š Monte Carlo Projection</div>
    <div class="chart-card">
      <div class="chart-container">
        <canvas id="mcChart"></canvas>
      </div>
      <div class="chart-legend">
        <span><span class="legend-dot" style="background:var(--green)"></span> Median Path</span>
        <span><span class="legend-dot" style="background:rgba(0,255,136,0.25)"></span> 25thâ€“75th %ile</span>
        <span><span class="legend-dot" style="background:rgba(0,255,136,0.08)"></span> 5thâ€“95th %ile</span>
        <span><span class="legend-dot" style="background:rgba(255,255,255,0.1)"></span> Sample Paths</span>
      </div>
    </div>
  </div>

  <!-- SCENARIO COMPARISON -->
  <div class="section-title">âš¡ Quick Compare â€” <span style="color:var(--text-muted);font-size:0.7rem;text-transform:none;letter-spacing:0">click to apply</span></div>
  <div class="scenarios" id="scenarios">
    <div class="scenario-card" onclick="quickScenario(1)" id="sc1">
      <div class="scenario-label">Conservative</div>
      <div class="scenario-risk">1%</div>
      <div class="scenario-metric">Median: <span class="val green" id="sc1med">â€”</span></div>
      <div class="scenario-metric">Best: <span class="val green" id="sc1best">â€”</span></div>
      <div class="scenario-metric">Worst: <span class="val red" id="sc1worst">â€”</span></div>
      <div class="scenario-metric">Max DD: <span class="val gold" id="sc1dd">â€”</span></div>
    </div>
    <div class="scenario-card active" onclick="quickScenario(2)" id="sc2">
      <div class="scenario-label">Current â­</div>
      <div class="scenario-risk">2%</div>
      <div class="scenario-metric">Median: <span class="val green" id="sc2med">â€”</span></div>
      <div class="scenario-metric">Best: <span class="val green" id="sc2best">â€”</span></div>
      <div class="scenario-metric">Worst: <span class="val red" id="sc2worst">â€”</span></div>
      <div class="scenario-metric">Max DD: <span class="val gold" id="sc2dd">â€”</span></div>
    </div>
    <div class="scenario-card" onclick="quickScenario(3)" id="sc3">
      <div class="scenario-label">Aggressive</div>
      <div class="scenario-risk">3%</div>
      <div class="scenario-metric">Median: <span class="val green" id="sc3med">â€”</span></div>
      <div class="scenario-metric">Best: <span class="val green" id="sc3best">â€”</span></div>
      <div class="scenario-metric">Worst: <span class="val red" id="sc3worst">â€”</span></div>
      <div class="scenario-metric">Max DD: <span class="val gold" id="sc3dd">â€”</span></div>
    </div>
    <div class="scenario-card" onclick="quickScenario(5)" id="sc4">
      <div class="scenario-label">YOLO ğŸ”¥</div>
      <div class="scenario-risk">5%</div>
      <div class="scenario-metric">Median: <span class="val green" id="sc4med">â€”</span></div>
      <div class="scenario-metric">Best: <span class="val green" id="sc4best">â€”</span></div>
      <div class="scenario-metric">Worst: <span class="val red" id="sc4worst">â€”</span></div>
      <div class="scenario-metric">Max DD: <span class="val gold" id="sc4dd">â€”</span></div>
    </div>
  </div>

  <!-- MILESTONES -->
  <div class="section-title">ğŸ† Milestones</div>
  <div class="milestones-grid" id="milestones">
    <!-- Populated by JS -->
  </div>

  <!-- STATS & DISTRIBUTION -->
  <div class="dist-section">
    <div class="section-title">ğŸ“‰ Risk Analysis</div>
    <div class="dist-card">
      <div class="dist-grid">
        <div class="dist-chart-wrap">
          <canvas id="ddChart"></canvas>
        </div>
        <div class="stat-block" id="statsBlock">
          <div class="stat-row">
            <span class="label">Median Final Balance</span>
            <span class="val" id="stMedian" style="color:var(--green)">â€”</span>
          </div>
          <div class="stat-row">
            <span class="label">Median Return</span>
            <span class="val" id="stReturn" style="color:var(--green)">â€”</span>
          </div>
          <div class="stat-row">
            <span class="label">Avg Max Drawdown</span>
            <span class="val" id="stAvgDD" style="color:var(--gold)">â€”</span>
          </div>
          <div class="stat-row">
            <span class="label">Worst Max Drawdown</span>
            <span class="val" id="stWorstDD" style="color:var(--red)">â€”</span>
          </div>
          <div class="stat-row">
            <span class="label">Prob. of Doubling</span>
            <span class="val" id="stDouble" style="color:var(--cyan)">â€”</span>
          </div>
          <div class="stat-row">
            <span class="label">Prob. of 10Ã—</span>
            <span class="val" id="st10x" style="color:var(--cyan)">â€”</span>
          </div>
          <div class="stat-row">
            <span class="label">Risk of 50%+ Loss</span>
            <span class="val" id="stRuin" style="color:var(--red)">â€”</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BACKTEST SOURCE -->
  <div class="section-title">ğŸ“‹ Data Source</div>
  <div class="source-card">
    <div class="source-item"><span>System</span><span class="val">V5.2 (Stop Hunt + Vector Exit)</span></div>
    <div class="source-item"><span>Trades</span><span class="val">87</span></div>
    <div class="source-item"><span>Win Rate</span><span class="val">63%</span></div>
    <div class="source-item"><span>Total R</span><span class="val">+115.88R</span></div>
    <div class="source-item"><span>Avg Win</span><span class="val">+2.69R</span></div>
    <div class="source-item"><span>Avg Loss</span><span class="val">-0.93R</span></div>
    <div class="source-item"><span>Timeframes</span><span class="val">1m / 15m / 1H</span></div>
    <div class="source-item"><span>Pairs (live)</span><span class="val">BTC, ETH, SOL</span></div>
    <div class="source-item"><span>Period</span><span class="val">Mar 2025 â€“ Feb 2026</span></div>
    <div class="source-item"><span>Method</span><span class="val">Bootstrap from actual R values</span></div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <a href="index.html">â† Back to Dashboard</a>
    &nbsp;|&nbsp;
    <a href="trading-live.html">Live Trading</a>
    &nbsp;|&nbsp;
    <a href="trading-rules.html">Trading Rules</a>
    <div class="footer-info">
      âš ï¸ Past performance â‰  future results. Simulation uses historical trade distribution.
      Slippage, fees, and liquidity not modeled.
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V5.2 BACKTEST R-VALUES (actual trades, bootstrap source)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BACKTEST_R = [
  // 1H: 35 trades (20W/15L = +37.91R)
  2.5, 1.5, 6.5, 0.6, -1.0, -1.0, -1.0, 0.6, 2.6, 5.0,
  -1.0, -1.0, -1.0, -1.0, -1.0, 0.9, 0.7, 1.4, 0.6, 1.5,
  -1.0, -1.0, 0.3, -1.0, 0.6, 2.5, -1.0, -1.0, 10.7, -1.0,
  8.9, 0.5, 3.2, 1.4, -0.4,
  // 15m: 21 trades (13W/8L = +30.64R)
  1.4, 2.7, -1.0, -0.2, -1.0, -1.0, 1.5, 0.9, 1.2, 2.3,
  -1.0, 5.4, 1.8, -1.0, 0.5, 2.3, 1.3, -1.0, 2.2, 14.4, -1.0,
  // 1m: 31 trades (22W/9L â‰ˆ +47.33R, V5.2 optimized)
  -1.0, 7.5, 0.6, 1.5, 1.3, 4.5, 1.9, 1.6, 2.6, -1.0,
  -1.0, 1.7, -1.0, 1.7, 3.8, -1.0, 3.2, 1.9, 0.5, -1.0,
  0.8, 0.7, 2.8, 1.0, 6.1, 1.9, 1.7, -1.0, -1.0, 2.5, 1.2
];

const NUM_SIMS = 500;
let mcChart = null;
let ddChart = null;
let currentResults = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const balSlider = document.getElementById('balSlider');
const riskSlider = document.getElementById('riskSlider');
const tradesSlider = document.getElementById('tradesSlider');

function updateLabels() {
  const bal = +balSlider.value;
  document.getElementById('balValue').textContent = bal >= 1000 ? '$' + (bal/1000).toFixed(bal%1000?1:0) + 'K' : '$' + bal;
  document.getElementById('riskValue').textContent = (+riskSlider.value).toFixed(1) + '%';
  document.getElementById('tradesValue').textContent = tradesSlider.value;

  // Update preset buttons
  updatePresets('balPresets', balSlider.value);
  updatePresets('riskPresets', riskSlider.value);
  updatePresets('tradePresets', tradesSlider.value);
}

function updatePresets(id, val) {
  const btns = document.querySelectorAll('#' + id + ' .preset-btn');
  btns.forEach(b => b.classList.toggle('active', b.dataset.val === String(val)));
}

balSlider.addEventListener('input', updateLabels);
riskSlider.addEventListener('input', updateLabels);
tradesSlider.addEventListener('input', updateLabels);

// Preset buttons
document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const val = btn.dataset.val;
    const parent = btn.parentElement;
    if (parent.id === 'balPresets') { balSlider.value = val; }
    else if (parent.id === 'riskPresets') { riskSlider.value = val; }
    else if (parent.id === 'tradePresets') { tradesSlider.value = val; }
    updateLabels();
  });
});

function quickScenario(risk) {
  riskSlider.value = risk;
  updateLabels();
  document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
  const idx = {1:1,2:2,3:3,5:4}[risk] || 2;
  document.getElementById('sc' + idx).classList.add('active');
  runSimulation();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONTE CARLO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sampleR() {
  return BACKTEST_R[Math.floor(Math.random() * BACKTEST_R.length)];
}

function simulate(startBal, riskPct, numTrades) {
  const paths = [];
  const finalBalances = [];
  const maxDrawdowns = [];

  for (let s = 0; s < NUM_SIMS; s++) {
    let balance = startBal;
    let peak = startBal;
    let maxDD = 0;
    const path = [startBal];

    for (let t = 0; t < numTrades; t++) {
      const r = sampleR();
      const riskAmt = balance * (riskPct / 100);
      balance += riskAmt * r;
      if (balance < 0.01) balance = 0.01; // floor

      if (balance > peak) peak = balance;
      const dd = (peak - balance) / peak;
      if (dd > maxDD) maxDD = dd;

      path.push(balance);
    }

    paths.push(path);
    finalBalances.push(balance);
    maxDrawdowns.push(maxDD);
  }

  // Sort final balances
  finalBalances.sort((a, b) => a - b);
  maxDrawdowns.sort((a, b) => a - b);

  // Calculate percentiles at each trade step
  const numSteps = numTrades + 1;
  const p5 = [], p25 = [], p50 = [], p75 = [], p95 = [];

  for (let i = 0; i < numSteps; i++) {
    const vals = paths.map(p => p[i]).sort((a, b) => a - b);
    p5.push(vals[Math.floor(vals.length * 0.05)]);
    p25.push(vals[Math.floor(vals.length * 0.25)]);
    p50.push(vals[Math.floor(vals.length * 0.50)]);
    p75.push(vals[Math.floor(vals.length * 0.75)]);
    p95.push(vals[Math.floor(vals.length * 0.95)]);
  }

  // Sample paths for display (10 random)
  const samplePaths = [];
  for (let i = 0; i < 10; i++) {
    samplePaths.push(paths[Math.floor(Math.random() * paths.length)]);
  }

  return {
    paths, samplePaths,
    percentiles: { p5, p25, p50, p75, p95 },
    finalBalances, maxDrawdowns,
    median: finalBalances[Math.floor(finalBalances.length * 0.5)],
    best: finalBalances[finalBalances.length - 1],
    worst: finalBalances[0],
    p5Final: finalBalances[Math.floor(finalBalances.length * 0.05)],
    p95Final: finalBalances[Math.floor(finalBalances.length * 0.95)],
    avgDD: maxDrawdowns.reduce((a, b) => a + b, 0) / maxDrawdowns.length,
    worstDD: maxDrawdowns[maxDrawdowns.length - 1],
    probDouble: finalBalances.filter(b => b >= startBal * 2).length / NUM_SIMS,
    prob10x: finalBalances.filter(b => b >= startBal * 10).length / NUM_SIMS,
    prob50Loss: finalBalances.filter(b => b <= startBal * 0.5).length / NUM_SIMS,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN SIMULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runSimulation() {
  const startBal = +balSlider.value;
  const riskPct = +riskSlider.value;
  const numTrades = +tradesSlider.value;

  const btn = document.getElementById('runBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Simulating...';

  // Use requestAnimationFrame to let UI update
  requestAnimationFrame(() => {
    setTimeout(() => {
      const result = simulate(startBal, riskPct, numTrades);
      currentResults = result;
      renderChart(result, numTrades, startBal);
      renderStats(result, startBal);
      renderMilestones(result, startBal, numTrades);
      renderDDChart(result);
      runScenarioComparison(startBal, numTrades);

      btn.disabled = false;
      btn.textContent = 'ğŸš€ Run Simulation (500 paths)';
    }, 20);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChart(result, numTrades, startBal) {
  const { percentiles, samplePaths } = result;
  const labels = Array.from({ length: numTrades + 1 }, (_, i) => i);

  // Determine scale
  const maxVal = percentiles.p95[percentiles.p95.length - 1];
  const useLog = maxVal / startBal > 50;

  if (mcChart) mcChart.destroy();

  const ctx = document.getElementById('mcChart').getContext('2d');

  const datasets = [];

  // Sample paths (faint)
  samplePaths.forEach((path, i) => {
    datasets.push({
      label: 'Path ' + i,
      data: path,
      borderColor: 'rgba(255,255,255,0.04)',
      borderWidth: 1,
      pointRadius: 0,
      fill: false,
      tension: 0.1,
    });
  });

  // 5-95 band (fill)
  datasets.push({
    label: '95th',
    data: percentiles.p95,
    borderColor: 'transparent',
    backgroundColor: 'transparent',
    pointRadius: 0,
    fill: false,
  });
  datasets.push({
    label: '5th',
    data: percentiles.p5,
    borderColor: 'transparent',
    backgroundColor: 'rgba(0,255,136,0.04)',
    pointRadius: 0,
    fill: '-1',
  });

  // 25-75 band
  datasets.push({
    label: '75th',
    data: percentiles.p75,
    borderColor: 'transparent',
    backgroundColor: 'transparent',
    pointRadius: 0,
    fill: false,
  });
  datasets.push({
    label: '25th',
    data: percentiles.p25,
    borderColor: 'transparent',
    backgroundColor: 'rgba(0,255,136,0.1)',
    pointRadius: 0,
    fill: '-1',
  });

  // Median (hero line)
  datasets.push({
    label: 'Median',
    data: percentiles.p50,
    borderColor: '#00ff88',
    borderWidth: 2.5,
    pointRadius: 0,
    fill: false,
    tension: 0.2,
  });

  // Starting balance reference
  datasets.push({
    label: 'Start',
    data: Array(numTrades + 1).fill(startBal),
    borderColor: 'rgba(255,255,255,0.12)',
    borderWidth: 1,
    borderDash: [6, 4],
    pointRadius: 0,
    fill: false,
  });

  mcChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 600 },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(17,17,24,0.95)',
          borderColor: 'rgba(30,30,46,1)',
          borderWidth: 1,
          titleColor: '#a1a1aa',
          bodyColor: '#e4e4e7',
          padding: 12,
          displayColors: false,
          filter: function(item) {
            return item.dataset.label === 'Median' || item.dataset.label === '5th' || item.dataset.label === '95th';
          },
          callbacks: {
            title: ctx => 'Trade #' + ctx[0].label,
            label: ctx => {
              const name = ctx.dataset.label;
              if (name === 'Start') return null;
              return name + ': $' + fmtBal(ctx.parsed.y);
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Trades', color: '#71717a', font: { size: 11 } },
          ticks: { color: '#71717a', maxTicksLimit: 10, font: { size: 10 } },
          grid: { color: 'rgba(30,30,46,0.5)', drawBorder: false }
        },
        y: {
          type: useLog ? 'logarithmic' : 'linear',
          ticks: {
            color: '#71717a',
            font: { size: 10 },
            callback: v => '$' + fmtBal(v)
          },
          grid: { color: 'rgba(30,30,46,0.5)', drawBorder: false }
        }
      }
    }
  });
}

function renderDDChart(result) {
  const { maxDrawdowns } = result;

  // Histogram bins (0-5%, 5-10%, ..., 45-50%, 50%+)
  const bins = [];
  const binSize = 5;
  const numBins = 12;
  for (let i = 0; i < numBins; i++) bins.push(0);

  maxDrawdowns.forEach(dd => {
    const pct = dd * 100;
    let idx = Math.floor(pct / binSize);
    if (idx >= numBins) idx = numBins - 1;
    bins[idx]++;
  });

  const labels = [];
  for (let i = 0; i < numBins; i++) {
    if (i === numBins - 1) labels.push((i * binSize) + '%+');
    else labels.push((i * binSize) + '-' + ((i + 1) * binSize) + '%');
  }

  if (ddChart) ddChart.destroy();
  const ctx = document.getElementById('ddChart').getContext('2d');

  ddChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: bins,
        backgroundColor: bins.map((_, i) => {
          if (i <= 2) return 'rgba(0,255,136,0.5)';
          if (i <= 4) return 'rgba(251,191,36,0.5)';
          return 'rgba(255,68,68,0.5)';
        }),
        borderRadius: 4,
        barPercentage: 0.85,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 400 },
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Max Drawdown Distribution',
          color: '#71717a',
          font: { size: 11, weight: '600' },
          padding: { bottom: 8 }
        },
        tooltip: {
          backgroundColor: 'rgba(17,17,24,0.95)',
          callbacks: {
            label: ctx => ctx.parsed.y + ' sims (' + Math.round(ctx.parsed.y / NUM_SIMS * 100) + '%)'
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#71717a', font: { size: 9 }, maxRotation: 45 },
          grid: { display: false }
        },
        y: {
          ticks: { color: '#71717a', font: { size: 9 } },
          grid: { color: 'rgba(30,30,46,0.3)' }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(result, startBal) {
  document.getElementById('stMedian').textContent = '$' + fmtBal(result.median);
  const ret = (result.median - startBal) / startBal * 100;
  document.getElementById('stReturn').textContent = '+' + fmtNum(ret, 0) + '%';
  document.getElementById('stAvgDD').textContent = fmtNum(result.avgDD * 100, 1) + '%';
  document.getElementById('stWorstDD').textContent = fmtNum(result.worstDD * 100, 1) + '%';
  document.getElementById('stDouble').textContent = fmtNum(result.probDouble * 100, 0) + '%';
  document.getElementById('st10x').textContent = fmtNum(result.prob10x * 100, 0) + '%';
  document.getElementById('stRuin').textContent = fmtNum(result.prob50Loss * 100, 1) + '%';
}

function renderMilestones(result, startBal, numTrades) {
  const milestoneTargets = [];
  // Dynamic milestones based on starting balance
  const multipliers = [2, 5, 10, 50, 100, 500, 1000];
  multipliers.forEach(m => {
    const target = startBal * m;
    if (target >= startBal * 1.5) { // at least 1.5x
      milestoneTargets.push({ target, mult: m + 'Ã—' });
    }
  });

  // Also add absolute milestones
  [1000, 10000, 100000, 1000000].forEach(t => {
    if (t > startBal * 1.5 && !milestoneTargets.find(m => Math.abs(m.target - t) < t * 0.1)) {
      milestoneTargets.push({ target: t, mult: fmtBal(t) });
    }
  });

  // Sort and limit to 8
  milestoneTargets.sort((a, b) => a.target - b.target);
  const display = milestoneTargets.slice(0, 8);

  const container = document.getElementById('milestones');
  container.innerHTML = '';

  display.forEach(ms => {
    // Find median trades to reach this target
    const { paths } = currentResults;
    let reachedCount = 0;
    let tradesToReach = [];

    paths.forEach(path => {
      for (let i = 0; i < path.length; i++) {
        if (path[i] >= ms.target) {
          tradesToReach.push(i);
          reachedCount++;
          break;
        }
      }
    });

    const prob = reachedCount / NUM_SIMS;
    tradesToReach.sort((a, b) => a - b);
    const medianTrades = tradesToReach.length > 0 ? tradesToReach[Math.floor(tradesToReach.length * 0.5)] : 'â€”';
    const fastTrades = tradesToReach.length > 0 ? tradesToReach[Math.floor(tradesToReach.length * 0.1)] : 'â€”';

    const colors = ['#00ff88', '#06b6d4', '#3b82f6', '#a855f7', '#fbbf24', '#f97316', '#ef4444', '#ec4899'];
    const color = colors[display.indexOf(ms) % colors.length];

    const card = document.createElement('div');
    card.className = 'milestone-card animate-in';
    card.style.animationDelay = (display.indexOf(ms) * 0.05) + 's';
    card.innerHTML = `
      <div class="milestone-target" style="color:${color}">$${fmtBal(ms.target)}</div>
      <div class="milestone-mult">${ms.mult} from start</div>
      <div class="milestone-bar-wrap">
        <div class="milestone-bar" style="width:${Math.min(prob * 100, 100)}%;background:${color}"></div>
      </div>
      <div class="milestone-stats">
        <span><span class="label">Probability: </span><span class="val" style="color:${prob > 0.7 ? 'var(--green)' : prob > 0.3 ? 'var(--gold)' : 'var(--red)'}">${fmtNum(prob * 100, 0)}%</span></span>
        <span><span class="label">Median: </span><span class="val">${medianTrades === 'â€”' ? 'â€”' : medianTrades + ' trades'}</span></span>
      </div>
      <div class="milestone-stats" style="margin-top:4px">
        <span><span class="label">Fast (10th): </span><span class="val">${fastTrades === 'â€”' ? 'â€”' : fastTrades + ' trades'}</span></span>
      </div>
    `;
    container.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENARIO COMPARISON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runScenarioComparison(startBal, numTrades) {
  [1, 2, 3, 5].forEach((risk, idx) => {
    const r = simulate(startBal, risk, numTrades);
    const n = idx + 1;
    document.getElementById('sc' + n + 'med').textContent = '$' + fmtBal(r.median);
    document.getElementById('sc' + n + 'best').textContent = '$' + fmtBal(r.p95Final);
    document.getElementById('sc' + n + 'worst').textContent = '$' + fmtBal(r.p5Final);
    document.getElementById('sc' + n + 'dd').textContent = fmtNum(r.avgDD * 100, 0) + '%';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtNum(n, dec) {
  return Number(n).toFixed(dec);
}

function fmtBal(n) {
  if (n === undefined || n === null || isNaN(n)) return 'â€”';
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e4) return (n / 1e3).toFixed(1) + 'K';
  if (n >= 1000) return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
  return n.toFixed(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Auto-run on load
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updateLabels();
runSimulation();
</script>
</body>
</html>
