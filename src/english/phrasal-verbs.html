<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phrasal Verbs Progress</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { 
            text-align: center; 
            margin-bottom: 8px; 
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #888; margin-bottom: 24px; }
        
        .sync-status {
            text-align: center;
            padding: 8px 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            color: #22c55e;
        }
        .sync-status.warning {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
            color: #eab308;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-value { 
            font-size: 2rem; 
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label { color: #888; font-size: 0.85rem; }
        .streak { color: #f59e0b !important; -webkit-text-fill-color: #f59e0b !important; }
        
        .section-title {
            font-size: 1.25rem;
            margin-bottom: 16px;
            margin-top: 24px;
        }
        
        .info-box {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        .info-box p { color: #a78bfa; margin-bottom: 8px; }
        .info-box .emoji { font-size: 2rem; margin-bottom: 8px; }
        
        .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            height: 32px;
            display: flex;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 30px;
        }
        .seg-box0 { background: #ef4444; }
        .seg-box1 { background: #f59e0b; }
        .seg-box2 { background: #eab308; }
        .seg-box3 { background: #84cc16; }
        .seg-box4 { background: #22c55e; }
        .seg-box5 { background: #10b981; }
        
        .progress-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
            font-size: 0.75rem;
            color: #888;
            flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 4px; }
        
        .leitner-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .leitner-box {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .box-title { font-weight: 600; font-size: 0.9rem; }
        .box-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .box-interval { font-size: 0.7rem; color: #666; margin-bottom: 12px; }
        .box-verbs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .verb-chip {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .box-0 .verb-chip { border-left: 2px solid #ef4444; }
        .box-1 .verb-chip { border-left: 2px solid #f59e0b; }
        .box-2 .verb-chip { border-left: 2px solid #eab308; }
        .box-3 .verb-chip { border-left: 2px solid #84cc16; }
        .box-4 .verb-chip { border-left: 2px solid #22c55e; }
        .box-5 .verb-chip { border-left: 2px solid #10b981; }
        
        .sessions-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .session-item:last-child { border-bottom: none; }
        .session-info { display: flex; flex-direction: column; }
        .session-date { color: #888; font-size: 0.85rem; }
        .session-score { 
            font-weight: 700; 
            font-size: 1.5rem;
            padding: 4px 12px;
            border-radius: 8px;
        }
        .session-score.excellent { color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .session-score.good { color: #84cc16; background: rgba(132, 204, 22, 0.1); }
        .session-score.ok { color: #eab308; background: rgba(234, 179, 8, 0.1); }
        .session-score.needs-work { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        .footer {
            text-align: center;
            color: #555;
            font-size: 0.8rem;
            margin-top: 32px;
        }
        .backup-buttons {
            margin-top: 16px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        .backup-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #888;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .backup-btn:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .leitner-boxes { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="../index.html" style="position:fixed;top:16px;left:16px;color:#888;text-decoration:none;font-size:0.9rem;z-index:1000;background:rgba(0,0,0,0.5);padding:8px 12px;border-radius:8px;">‚Üê Dashboard</a>
    <div class="container">
        <h1>üöÄ Phrasal Verbs Progress</h1>
        <p class="subtitle">400 verbs ‚Ä¢ Leitner spaced repetition ‚Ä¢ Practice in Telegram ‚ú®</p>
        
        <div class="sync-status" id="syncStatus">
            ‚úÖ Synced ‚Ä¢ Loading...
        </div>
        
        <div class="info-box">
            <div class="emoji">üí¨</div>
            <p><strong>Practice happens in Telegram with Nova</strong></p>
            <p style="font-size: 0.85rem; color: #888;">Data saved locally + synced to server automatically</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="sessions">0</div>
                <div class="stat-label">Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalQuestions">0</div>
                <div class="stat-label">Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accuracy">‚Äî</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVerbs">0</div>
                <div class="stat-label">Verbs Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="masteredCount">0</div>
                <div class="stat-label">Mastered</div>
            </div>
            <div class="stat-card">
                <div class="stat-value streak" id="streak">0</div>
                <div class="stat-label">üî• Streak</div>
            </div>
        </div>
        
        <div class="section-title">üéØ Mastery Progress</div>
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Box 0: New</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>Box 1: 1 day</div>
            <div class="legend-item"><div class="legend-dot" style="background:#eab308"></div>Box 2: 3 days</div>
            <div class="legend-item"><div class="legend-dot" style="background:#84cc16"></div>Box 3: 7 days</div>
            <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Box 4: 14 days</div>
            <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div>Box 5: Mastered</div>
        </div>
        
        <div class="section-title">üì¶ Leitner Boxes</div>
        <div class="leitner-boxes" id="leitnerBoxes"></div>
        
        <div class="section-title">üìä Session History</div>
        <div class="sessions-section">
            <div id="sessionsList"></div>
        </div>
        
        <div class="footer">
            <div>Synced from Nova ‚ú® ‚Ä¢ Last updated: <span id="lastUpdated">‚Äî</span></div>
            <div class="backup-buttons">
                <button class="backup-btn" onclick="exportData()">üì• Export Backup</button>
                <button class="backup-btn" onclick="document.getElementById('importFile').click()">üì§ Import Backup</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
        </div>
    </div>
    
    <script>
        const STORAGE_KEY = 'phrasal-verbs-progress';
        const VERSION_KEY = 'phrasal-verbs-version';
        let currentData = null;
        
        // Load data: localStorage first, then server, merge if needed
        async function loadData() {
            const syncStatus = document.getElementById('syncStatus');
            
            try {
                // 1. Try localStorage first
                const localData = localStorage.getItem(STORAGE_KEY);
                const localVersion = localStorage.getItem(VERSION_KEY);
                
                // 2. Fetch from server
                const response = await fetch('progress-data.json?t=' + Date.now());
                const serverData = await response.json();
                const serverVersion = serverData.lastSession || serverData.lastUpdated;
                
                // 3. Decide which to use
                if (localData) {
                    const local = JSON.parse(localData);
                    const localTime = new Date(localVersion || 0).getTime();
                    const serverTime = new Date(serverVersion || 0).getTime();
                    
                    if (localTime > serverTime) {
                        // Local is newer - use local, warn about sync
                        currentData = local;
                        syncStatus.className = 'sync-status warning';
                        syncStatus.innerHTML = '‚ö†Ô∏è Local data is newer than server ‚Ä¢ <a href="#" onclick="forceServerSync()" style="color:#eab308">Use server data</a>';
                    } else {
                        // Server is newer or same - use server, update local
                        currentData = serverData;
                        saveToLocal(serverData);
                        syncStatus.innerHTML = '‚úÖ Synced with server ‚Ä¢ ' + new Date(serverVersion).toLocaleString();
                    }
                } else {
                    // No local data - use server, save to local
                    currentData = serverData;
                    saveToLocal(serverData);
                    syncStatus.innerHTML = '‚úÖ Loaded from server ‚Ä¢ ' + new Date(serverVersion).toLocaleString();
                }
                
                renderData(currentData);
                
            } catch (e) {
                console.error('Failed to load data:', e);
                
                // Try localStorage as fallback
                const localData = localStorage.getItem(STORAGE_KEY);
                if (localData) {
                    currentData = JSON.parse(localData);
                    syncStatus.className = 'sync-status warning';
                    syncStatus.innerHTML = '‚ö†Ô∏è Offline mode ‚Ä¢ Using cached data';
                    renderData(currentData);
                } else {
                    syncStatus.className = 'sync-status warning';
                    syncStatus.innerHTML = '‚ùå Failed to load data';
                }
            }
        }
        
        function saveToLocal(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            localStorage.setItem(VERSION_KEY, data.lastSession || data.lastUpdated || new Date().toISOString());
        }
        
        function forceServerSync() {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(VERSION_KEY);
            location.reload();
        }
        
        function renderData(data) {
            const boxes = data.boxes || {};
            
            // Count verbs per box
            const boxCounts = [0, 0, 0, 0, 0, 0];
            let totalVerbs = 0;
            for (let i = 0; i <= 5; i++) {
                const count = (boxes[String(i)] || boxes[i] || []).length;
                boxCounts[i] = count;
                totalVerbs += count;
            }
            
            // Calculate accuracy from sessions
            const sessions = data.sessionHistory || [];
            let totalQ = 0, totalC = 0;
            sessions.forEach(s => { totalQ += s.questions || 0; totalC += s.correct || 0; });
            const accuracy = totalQ > 0 ? Math.round((totalC / totalQ) * 100) : 0;
            
            // Update stats
            document.getElementById('sessions').textContent = data.totalSessions || sessions.length || 0;
            document.getElementById('totalQuestions').textContent = totalQ;
            document.getElementById('accuracy').textContent = accuracy > 0 ? accuracy + '%' : '‚Äî';
            document.getElementById('totalVerbs').textContent = totalVerbs;
            document.getElementById('masteredCount').textContent = boxCounts[5];
            document.getElementById('streak').textContent = data.currentStreak || 0;
            
            // Progress bar
            if (totalVerbs > 0) {
                document.getElementById('progressBar').innerHTML = boxCounts.map((count, i) => 
                    count > 0 ? `<div class="progress-segment seg-box${i}" style="width: ${(count/totalVerbs)*100}%">${count}</div>` : ''
                ).join('');
            }
            
            // Leitner boxes
            const boxLabels = [
                {name: 'Box 0', interval: 'New / Need work'},
                {name: 'Box 1', interval: 'Review in 1 day'},
                {name: 'Box 2', interval: 'Review in 3 days'},
                {name: 'Box 3', interval: 'Review in 7 days'},
                {name: 'Box 4', interval: 'Review in 14 days'},
                {name: 'Box 5', interval: 'Mastered! üéâ'}
            ];
            
            document.getElementById('leitnerBoxes').innerHTML = boxLabels.map((label, i) => {
                const verbs = boxes[String(i)] || boxes[i] || [];
                return `
                    <div class="leitner-box box-${i}">
                        <div class="box-header">
                            <span class="box-title">${label.name}</span>
                            <span class="box-count">${verbs.length}</span>
                        </div>
                        <div class="box-interval">${label.interval}</div>
                        <div class="box-verbs">
                            ${verbs.slice(0, 10).map(v => `<span class="verb-chip">${v}</span>`).join('')}
                            ${verbs.length > 10 ? `<span class="verb-chip" style="color:#666">+${verbs.length - 10} more</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Session history
            const sessionsHtml = sessions.slice().reverse().slice(0, 10).map(s => {
                let scoreClass = 'needs-work';
                if (s.pct >= 85) scoreClass = 'excellent';
                else if (s.pct >= 70) scoreClass = 'good';
                else if (s.pct >= 50) scoreClass = 'ok';
                
                return `
                    <div class="session-item">
                        <div class="session-info">
                            <span class="session-date">${s.date} ‚Ä¢ Session ${s.session}</span>
                            <span>${s.correct}/${s.questions} correct</span>
                        </div>
                        <span class="session-score ${scoreClass}">${s.pct}%</span>
                    </div>
                `;
            }).join('');
            document.getElementById('sessionsList').innerHTML = sessionsHtml || '<p style="color:#666;text-align:center;padding:20px;">No sessions yet</p>';
            
            // Last updated
            document.getElementById('lastUpdated').textContent = data.lastSession 
                ? new Date(data.lastSession).toLocaleString() 
                : data.lastUpdated || '‚Äî';
        }
        
        // Export data as JSON file
        function exportData() {
            if (!currentData) return alert('No data to export');
            const blob = new Blob([JSON.stringify(currentData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `phrasal-verbs-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.boxes) {
                        alert('Invalid backup file - missing boxes data');
                        return;
                    }
                    saveToLocal(data);
                    currentData = data;
                    renderData(data);
                    document.getElementById('syncStatus').innerHTML = '‚úÖ Imported from backup ‚Ä¢ ' + new Date().toLocaleString();
                    alert('Backup restored! Note: This is only saved locally. Ask Nova to sync to server.');
                } catch (err) {
                    alert('Failed to import: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }
        
        loadData();
    </script>
</body>
</html>
